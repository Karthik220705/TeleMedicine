{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Video Consultation</h4>
        </div>
        <div class="card-body">
            <div id="jitsi-container" style="height: 600px; border: 1px solid #ddd; border-radius: 8px;"></div>
            
            <div class="mt-4">
                <h5>Appointment Details</h5>
                <p>Doctor: Dr. {{ appointment.doctor.name }}</p>
                <p>Patient: {{ appointment.patient.name }}</p>
                <p>Time: {{ appointment.appointment_time.strftime('%Y-%m-%d %H:%M') }}</p>
                <p>Room ID: {{ appointment.room_id }}</p>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script src='https://meet.jit.si/external_api.js'></script>
<script>
let jitsiApi = null;

function initializeJitsi() {
    if (jitsiApi) return;

    const options = {
        roomName: 'Teledoctor-{{ appointment.room_id }}',
        parentNode: document.querySelector('#jitsi-container'),
        userInfo: {
            displayName: '{{ session.name }} ({{ session.role|capitalize }})'
        },
        configOverwrite: {
            prejoinPageEnabled: false,
            disableDeepLinking: true
        },
        interfaceConfigOverwrite: {
            DEFAULT_BACKGROUND: '#f8f9fa',
            SHOW_JITSI_WATERMARK: false
        }
    };

    jitsiApi = new JitsiMeetExternalAPI('meet.jit.si', options);
}

document.addEventListener('DOMContentLoaded', initializeJitsi);
window.addEventListener('beforeunload', () => {
    if (jitsiApi) jitsiApi.dispose();
});
</script>
{% endblock %}
{% endblock %}
